<!doctype html>

<html>
	<head>
		<title>Deforestation</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">
		<link rel="stylesheet" href="leaflet/leaflet.css" />
		<script src="leaflet/leaflet.js"></script>
		<link rel="stylesheet" href="leaflet/leaflet.fullscreen.css" />
		<script src="leaflet/leaflet.fullscreen.js"></script>
		<script src="leaflet/leaflet.fullscreen.js"></script>
		<script src="highcharts/highcharts.js"></script>
		<script src="highcharts/sankey.js"></script>
		<script src="highcharts/dependency-wheel.js"></script>
		<script src="highcharts/exporting.js"></script>
		<script src="highcharts/export-data.js"></script>
		<script src="highcharts/accessibility.js"></script>
		<!-- for reading GeoTIFF: -->
		<script src="https://d3js.org/d3.v4.min.js"></script>
		<script src="https://npmcdn.com/geotiff@0.3.6/dist/geotiff.js"></script>
		<script src="https://ihcantabria.github.io/Leaflet.CanvasLayer.Field/dist/leaflet.canvaslayer.field.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.0/chroma.min.js"></script>
		<!-- for the trendline -->
		<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-trendline"></script>
		<style>
			html, body {
				height: 100%;
				margin: 0;
				font-family: 'Open Sans', 'OpenSans-Local';
				font-style: normal;
				color: #373f27;
				background-color: #FFF8EA;
			} 
			
			p {
				text-align: justify;
				color: #594545;
			}
			
			#map, #map_dynamic, #map_2 {
				width: 65%;
				height: 400px;
				margin:  auto;
			}
			
			
			.section {
				padding-left: 250px;
				padding-right: 250px;
				padding-top: 5px;
				padding-bottom: 5px;
			}
			.imagesection {
			}
			.datawrapper_element {
			  background-color: white;
			  padding-top: 10px;
			  padding-bottom: 10px;
			  padding-left: 30px;
			  padding-right: 30px;
			}
			.cim_a_kepen {
				color: white; 
				font-weight: bold; 
				font-size: 15pt;
				text-shadow: 2px 2px 5px #000000c7;
			}
			/* Scroll reveal animation: https://alvarotrigo.com/blog/css-animations-scroll/ */
			.reveal {
			  position: relative;
			  transform: translateY(150px);
			  opacity: 0;
			  transition: 2s all ease;
			}
			.reveal.active{
			  transform: translateY(0);
			  opacity: 1;
			}
			#topbar {
				background-color: white;
				width: 100%;
				top: 0;
				height: 150px;
				padding-top: 24px;
				padding-bottom: 24px;
				padding-left: 38px;
				padding-right: 38px;
				display: flex;
				box-sizing: border-box;
			}
			
			/* Highcharts */
			.highcharts-data-table table {
				font-family: Verdana, sans-serif;
				border-collapse: collapse;
				border: 1px solid #ebebeb;
				margin: 10px auto;
				text-align: center;
				width: 100%;
				max-width: 500px;
			}

			.highcharts-data-table caption {
				padding: 1em 0;
				font-size: 1.2em;
				color: #555;
			}

			.highcharts-data-table th {
				font-weight: 600;
				padding: 0.5em;
			}

			.highcharts-data-table td,
			.highcharts-data-table th,
			.highcharts-data-table caption {
				padding: 0.5em;
			}

			.highcharts-data-table thead tr,
			.highcharts-data-table tr:nth-child(even) {
				background: #f8f8f8;
			}

			.highcharts-data-table tr:hover {
				background: #f1f7ff;
			}

			#csv {
				display: none;
			}
			
			/* Legends */
			.legend {
				display: flex; 
				flex-direction: row; 
				justify-content: flex-start; 
				grid-column-gap: 10px;
			}
			.legend span {
				position: relative;
				bottom: 3px;
				margin-top: 6px;
			}
			.legendcolumnlist {
				display: flex; 
				flex-direction: column; 
				justify-content: center; 
				grid-row-gap: 1px;
			}
			.legenditem {
				display: flex; 
				flex-direction: row; 
				align-items: center;
			}
			.custom-control {
				background-color: #FFFFFFDD; 
				padding: 6px 8px;
			}
			#buttonpanel {
				position: absolute;
				bottom: 5px; left: 5px;
				background: rgba(255,255,255,0.4);
				padding: 10px;
				border: solid 2px black;
				border-radius: 5px;
				z-index: 10000;
				text-align: center;
				backdrop-filter: blur(10px);
			}
		</style>
	</head>
	<body>
		
		<div id="topbar">
			<div style="display: flex; flex-direction: row; justify-content: space-between; align-items: center; width: 100%">
				<img src="stop.jpg" style="height: 130px"></img>
				<h1 style="font-size:20px;">Rapidly increasing deforestation of the Amazon rainforest</h1>
				<div style="display: flex; flex-direction: row; column-gap: 20px;">
					<a href="#section1">Deforestation by states</a>
					<a href="https://www.w3schools.com">Visit W3Schools</a>
					<a href="https://www.w3schools.com">Visit W3Schools</a>
				</div>
			</div>
		</div>
			
		<div id="maincontent" style="display: flex; flex-direction: column; row-gap: 20px;">			
			
			<div id="imagesection1" class="imagesection reveal">
				<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);" class="cim_a_kepen">The Amazon is the largest tropical forest and offers many important ecosystem services, including the sequestration of substantial amounts of carbon, recycling of moisture and supporting biodiversity. Deforestation is one of the major threats that the Amazon is currently facing(Fig 1). Since the early 2000s the rate of deforestation in the Amazon has steadily reduced, but is rising again since ~2018 (Fig 2). Earlier research has shown that deforestation can have a short positive effect on local communities (as expressed by the Human Development Index), but that this effect does not last for long.</div>
				<img src="forest.jpg" style="max-width: 100%"></img>
			</div>
			
			<div id="section0" class="section reveal">
				<h2>States Map</h2>
				<p>The Amazon is the largest tropical forest and offers many important ecosystem services, including the sequestration of substantial amounts of carbon, recycling of moisture and supporting biodiversity. Deforestation is one of the major threats that the Amazon is currently facing(Fig 1). Since the early 2000s the rate of deforestation in the Amazon has steadily reduced, but is rising again since ~2018 (Fig 2). Earlier research has shown that deforestation can have a short positive effect on local communities (as expressed by the Human Development Index), but that this effect does not last for long. </p>
				<div id="map"></div>
				blablabla
				<div id="map_dynamic"></div>
			</div>
			
			
			<div id="section1" class="section reveal">
				<figure class="highcharts-figure">
					<div id="container"></div>
						<p class="highcharts-description">
							Chart showing a dependency wheel, where each point consists of multiple
							weighted links to other points. This chart type is often used to
							visualize data flow, and can be a striking way to illustrate
							elationships in data.
						</p>
				</figure>
				<h2>Deforestation by states (Legal Amazon)</h2>
				<p>The Amazon is the largest tropical forest and offers many important ecosystem services, including the sequestration of substantial amounts of carbon, recycling of moisture and supporting biodiversity. Deforestation is one of the major threats that the Amazon is currently facing(Fig 1). Since the early 2000s the rate of deforestation in the Amazon has steadily reduced, but is rising again since ~2018 (Fig 2). Earlier research has shown that deforestation can have a short positive effect on local communities (as expressed by the Human Development Index), but that this effect does not last for long.  </p>
				<div id="diagram" class="datawrapper_element">
					<iframe title="Deforestation increments by states - Legal Amazon 
					" aria-label="Interactive line chart" id="datawrapper-chart-Hj5aG" src="https://datawrapper.dwcdn.net/Hj5aG/2/" scrolling="no" frameborder="0" style="width: 0; min-width: 100% !important; border: none;" height="518"></iframe><script type="text/javascript">!function(){"use strict";window.addEventListener("message",(function(e){if(void 0!==e.data["datawrapper-height"]){var t=document.querySelectorAll("iframe");for(var a in e.data["datawrapper-height"])for(var r=0;r<t.length;r++){if(t[r].contentWindow===e.source)t[r].style.height=e.data["datawrapper-height"][a]+"px"}}}))}();</script>
				</div>
			</div>
			
			<div id="map_2"></div>
			
			<div id="imagesection2" class="imagesection reveal">
				<img src="fire.jpg" style="max-width: 100%"></img>
			</div>
			
			<div id="section2" class="section reveal">
				<h2>What is NIRv?</h2>
				<iframe frameborder="0" class="juxtapose" width="100%" height="772" src="https://cdn.knightlab.com/libs/juxtapose/latest/embed/index.html?uid=cf48f9c4-8cfd-11ed-b5bd-6595d9b17862"></iframe>
				
			</div>

			<div id="section4" class="section reveal">
				<div>
					<canvas id="dualaxisChart" width="100%" height="400px"></canvas>
				</div>
				<div>
					<canvas id="dualaxisChart2" width="100%" height="400px"></canvas>
				</div>
				<div>
					<canvas id="dualaxisChart3" width="100%" height="400px"></canvas>
				</div>
				<div>
					<canvas id="scatterplot" width="100%" height="400px"></canvas>
				</div>
				<div>
					<canvas id="scatterplot2" width="100%" height="400px"></canvas>
				</div>
				
		</div>
		
		
		<script>
			// Scroll reveal animation: https://alvarotrigo.com/blog/css-animations-scroll/
			function reveal() {
			  var reveals = document.querySelectorAll(".reveal");
			  for (var i = 0; i < reveals.length; i++) {
				var windowHeight = window.innerHeight;
				var elementTop = reveals[i].getBoundingClientRect().top;
				var elementVisible = 150;
				if (elementTop < windowHeight - elementVisible) {
				  reveals[i].classList.add("active");
				} else {
				  reveals[i].classList.remove("active");
				}
			  }
			}
			
			window.addEventListener("scroll", reveal);

			// To check the scroll position on page load
			reveal();
			
			function areatokm2(value) {
				result = value/1000000
				return result
			}
			
			function tooltip_deforestation(layer) {
				return "<b><div style='font-size:20px'>" + layer.feature.properties.nome + "</div></b><br> deforestation: " + layer.feature.properties.deforestation_average_deforestation_average.toFixed(2) + " %";
			}
			function tooltip_nirv(layer) {
				return "<b><div style='font-size:20px'>" + layer.feature.properties.nome + "</div></b><br> NIRV: " + layer.feature.properties.nirv_average_Average.toFixed(3);
			}
			function tooltip_precip(layer) {
				return "<b><div style='font-size:20px'>" + layer.feature.properties.nome + "</div></b><br> precipitation: " + layer.feature.properties.precip_by_states_2001_2019_VAL.toFixed(3);
			}
			function tooltip_population(layer) {
				return "<b><div style='font-size:20px'>" + layer.feature.properties.nome + "</div></b><br> population: " + layer.feature.properties.population_average_population_average.toLocaleString();
			}
			function tooltip_gdp(layer) {
				return "<b><div style='font-size:20px'>" + layer.feature.properties.nome + "</div></b><br> GDP (R$ 1 billion): " + layer.feature.properties.gdp_average_gdp_average;
			}
			
		
			
			function stilus_deforestation(feature){
				var p = feature.properties;
				
				if (p.deforestation_average_deforestation_average > 8.0900) {
					return {
						color: '#a50f15'
					}
				} else if (p.deforestation_average_deforestation_average > 5.9100){
					return {
						color: '#de2d26'
					};
				} else if (p.deforestation_average_deforestation_average > 2.4000){
					return {
						color: '#fb6a4a'
					};
				} else if (p.deforestation_average_deforestation_average > 0.6701){
					return {
						color: '#fc9272'
					};
				} else {
					return {
						color: '#fcbba1'
					};
				}
			} 
			
			function stilus_nirv(feature){
				var p = feature.properties;
				
				if (p.nirv_average_Average > 0.24327) {
					return {
						color: '#000c00'
					}
				} else if (p.nirv_average_Average > 0.22448){
					return {
						color: '#004000'
					};
				} else if (p.nirv_average_Average > 0.20270){
					return {
						color: '#008000'
					};
				} else if (p.nirv_average_Average > 0.15989){
					return {
						color: '#7fbf7f'
					};
				} else {
					return {
						color: '#e5f2e5'
					};
				}
			}
			
			function stilus_precip(feature){
				var p = feature.properties;
				
				if (p.precip_by_states_2001_2019_VAL > 7.0007) {
					return {
						color: '#beeb1d'
					}
				} else if (p.precip_by_states_2001_2019_VAL > 5.0864){
					return {
						color: '#d1ff00'
					};
				} else if (p.precip_by_states_2001_2019_VAL > 4.0013){
					return {
						color: '#d9ff00'
					};
				} else if (p.precip_by_states_2001_2019_VAL > 3.2645){
					return {
						color: '#f6f43e'
					};
				} else {
					return {
						color: '#feff63'
					};
				}
			}
			
			function stilus_population(feature){
				var p = feature.properties;
				
				if (p.population_average_population_average > 6.180) {
					return {
						color: '#4c4c00'
					}
				} else if (p.population_average_population_average > 4.790){
					return {
						color: '#7f7f00'
					};
				} else if (p.population_average_population_average > 3.210){
					return {
						color: '#b2b200'
					};
				} else if (p.population_average_population_average > 1.911){
					return {
						color: '#e5e500'
					};
				} else {
					return {
						color: '#ffff00'
					};
				}
			}
			
			function stilus_gdp(feature){
				var p = feature.properties;
				
				if (p.gdp_average_gdp_average > 98.75) {
					return {
						color: '#111111'
					}
				} else if (p.gdp_average_gdp_average > 72.12){
					return {
						color: '#333333'
					};
				} else if (p.gdp_average_gdp_average > 26.25){
					return {
						color: '#555555'
					};
				} else if (p.gdp_average_gdp_average > 9.75){
					return {
						color: '#777777'
					};
				} else {
					return {
						color: '#999999'
					};
				}
			}
			
			function stilus_slope(feature){
				var p = feature.properties;
				
				if (p.slope_slope == "y =-0.003x+8.253") {
					return {
						color: '#111111'
					}
				} else if (p.slope_slope == "y =-0.004x+7.036"){
					return {
						color: '#111111'
					};
				} else if (p.slope_slope == "y =0.005x+2.974"){
					return {
						color: '#111111'
					};
				} else if (p.slope_slope == "y =-0.018x+4.110"){
					return {
						color: '#555555'
					};
				} else if (p.slope_slope == "y =-0.027x+10.683"){
					return {
						color: '#555555'
					};
				} else if (p.slope_slope == "y =0.032x+3.073"){
				 	return {
						color: '#555555'
					};
				} else if (p.slope_slope == "y =-0.038x+10.078"){
					return {
						color: '#555555'
					};
				} else if (p.slope_slope == "y =-0.063x+6.600"){
					return {
						color: '#999999'
					};
				} else {
					return {
						color: '#999999'
					};
				}
			}
			
			function stilus_r2(feature){
				var p = feature.properties;
				
				if (p.correlation_r2_values_leaflet_r2 > 0.8) {
					return {
						color: '#111111'
					}
				} else if (p.correlation_r2_values_leaflet_r2 > 0.38){
					return {
						color: '#333333'
					};
				} else if (p.correlation_r2_values_leaflet_r2 > 0.201){
					return {
						color: '#555555'
					};
				} else if (p.correlation_r2_values_leaflet_r2 > 0.02){
					return {
						color: '#777777'
					};
				} else {
					return {
						color: '#999999'
					};
				}
			}
			
			function mousehighlight (feature, layer) {
					// when hover over the feature, highlight it
					layer.on('mouseover', function () {
						this.setStyle({
							'weight': '6',
							'fillOpacity': '1',
							'border-width': '0.5',
						});
					});
					// when we go off the feature, return to default style
					layer.on('mouseout', function () {
						this.setStyle({
							'fillColor': feature.properties.fillColor,
							'weight': '4',
							'fillOpacity': '0.6'
							
						});
					});
				}
				
				
			// map div object, main Leaflet object:
			var map = L.map('map',{maxBounds: L.latLngBounds(L.latLng(-29.935789, -94.974456), L.latLng(22.153948, -27.264859)),
								maxBoundsViscosity: 1.0
									}).setView([-6.641224624683114,-55.6095886343115], 4); 
			map.addControl(new L.Control.Fullscreen());
			map.scrollWheelZoom.disable();
			
			// base maps
			var OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);
			
			// overlays			
			var x=new XMLHttpRequest();
			x.open('get', 'data/main_map_2.geojson', false);
			x.send();
			var d=JSON.parse(x.responseText);
			var mainmap_deforestation = L.geoJSON(d,{style: stilus_deforestation, onEachFeature: mousehighlight}).bindTooltip(tooltip_deforestation);
				mainmap_deforestation.getAttribution = function() { return 'TerraBrasilis: DETER dataset'; };
			var mainmap_population = L.geoJSON(d,{style: stilus_population, onEachFeature: mousehighlight}).bindTooltip(tooltip_population);
				mainmap_population.getAttribution = function() { return 'Instituto Brasileiro de Geografia e Estatística - IBGE'; };
			var mainmap_gdp = L.geoJSON(d,{style: stilus_gdp, onEachFeature: mousehighlight}).bindTooltip(tooltip_gdp);
				mainmap_gdp.getAttribution = function() { return 'Instituto Brasileiro de Geografia e Estatística - IBGE'; };
			
			// we add the default layer to map to show when page is opened:
				mainmap_deforestation.addTo(map)
			
			// list of overlays
			var overlayMaps = {
				
				"Deforestation % ": mainmap_deforestation,
				"Population density": mainmap_population,
				"GDP ": mainmap_gdp
			};
			
			// GeoTIFF for nirv
			var tifftooltip_nirv;
			var tiff_url_nirv = "data/totalnirv.tif";
			d3.request(tiff_url_nirv).responseType('arraybuffer').get( function (error, tiffData) {
			
				let nirv = L.ScalarField.fromGeoTIFF(tiffData.response, bandIndex = 0);
				let layerNirv = L.canvasLayer.scalarField(nirv, {
						color: chroma.scale(['#1C6FF8', '#27BBE0', '#31DB92', '#1BF118', '#9BFA24', '#FEF720']).domain(nirv.range),		// first the colors from-to (can be 3+ colors too, but fix legend too), then in domain part: get the min and max values of dataset
						opacity: 1
				});
				
				layerNirv.on("mousemove", function(e) {
					// mouse moved
					if (e.value !== null) {							// value under mouse is not null
						if (tifftooltip_nirv !== null) {			// if tifftooltip_nirv is already open, close the previous tooltip so it does not get stuck on map
							map.closeTooltip(tifftooltip_nirv);
						}
						// create tooltip:
						tifftooltip_nirv = L.tooltip()
							.setLatLng(e.latlng)
							.setContent(parseFloat(`${e.value}`).toFixed(3));
						map.openTooltip(tifftooltip_nirv);			// open tooltip
					} else {										// value is null
						if (tifftooltip_nirv !== null) {			// if any tooltip is open, close it since we went elsewhere from the area with the cursor, so previous one does not get stuck
							map.closeTooltip(tifftooltip_nirv);
						}
					}
				});
				
				// lets add the tiff layer to the overlayMaps object (which lists our switchable layers)
				Object.assign(overlayMaps, { "NIRv": layerNirv });
				
				// enable (show) the layer switcher - DO THIS AFTER ADDING THE LAST LAYER IN CODE
				var layerControl = L.control.layers(overlayMaps, null, {collapsed:false}).addTo(map); 
			  
			});
			
			// GeoTIFF for precip
			var tifftooltip_precip;
			var tiff_url_precip = "data/meantotal.tif";
			d3.request(tiff_url_precip).responseType('arraybuffer').get( function (error, tiffData) {
			
				let precip = L.ScalarField.fromGeoTIFF(tiffData.response, bandIndex = 0);
				let layerprecip = L.canvasLayer.scalarField(precip, {
						color: chroma.scale(['red', 'orange', 'yellow', 'green', 'cyan', 'blue']).domain(precip.range),		// first the colors from-to (can be 3+ colors too, but fix legend too), then in domain part: get the min and max values of dataset
						opacity: 1
				});
				
				layerprecip.on("mousemove", function(e) {
					// mouse moved
					if (e.value !== null) {							// value under mouse is not null
						if (tifftooltip_precip !== null) {			// if tifftooltip_nirv is already open, close the previous tooltip so it does not get stuck on map
							map.closeTooltip(tifftooltip_precip);
						}
						// create tooltip:
						tifftooltip_precip = L.tooltip()
							.setLatLng(e.latlng)
							.setContent(parseFloat(`${e.value*1000}`).toFixed(3)+ ' mm/day');
						map.openTooltip(tifftooltip_precip);			// open tooltip
					} else {										// value is null
						if (tifftooltip_precip !== null) {			// if any tooltip is open, close it since we went elsewhere from the area with the cursor, so previous one does not get stuck
							map.closeTooltip(tifftooltip_precip);
						}
					}
				});
				
				// lets add the tiff layer to the overlayMaps object (which lists our switchable layers)
				Object.assign(overlayMaps, { "Precipitation": layerprecip });
				
			
			  
			});
			
			
			// HIGHCHARTS - DEPENDENCY WHEEL:
			Highcharts.chart('container', {

				title: {
					text: 'Correlation among social and natural factors'
				},
				
				subtitle: {
					text: 'Subtitle is something'
				},

				// tooltip lower row format
				tooltip: {
					//pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
					//pointFormat: '{index}. From {point.from} to {point.to}: {point.weight} {point.mas}'
					pointFormat: 'Correlation between {point.from} and {point.to}: {point.source}'
				},
				
				accessibility: {
					point: {
						valueDescriptionFormat: 'Correlation between {point.from} and {point.to}: {point.source}.'
					}
				},

				series: [{
					type: 'dependencywheel',
					name: 'Dependency wheel series', 				// appears on top of tooltip, indicating the series name
					cursor: 'pointer',								// make cursor a pointer cursor when hovering over the chart
					keys: ['from', 'to', 'weight', 'source'],
					data: [
						['valami', 'masvalami', 0.5, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['mittudomenmi', 'masvalami', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['wildfires', 'mittudomenmi', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['wildfires', 'hogy allnak epp a csillagok', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['wildfires', 'valami', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['logging', 'hogy allnak epp a csillagok', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['logging', 'valami', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['logging', 'masvalami', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['hogy allnak epp a csillagok', 'valami', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['valami', 'logging', 1, 'https://www.researchgate.net/publication/347306942_Quality_assessment_of_the_PRODES_Cerrado_deforestation_data'],
						['valami', 'hogy allnak epp a csillagok', 1]
					],
					dataLabels: {
						color: '#333',
						style: {
							textOutline: 'none'
						},
						textPath: {
							enabled: true
						},
						distance: 10
					},
					size: '95%',
					events: {
						click: function (event) {
							// on click of a relation, open the reference URL (paper, literature) from field "source", if it exists:
							if (event.point.source != null) {
								window.open(event.point.source, "_blank");
							}
						}
					}
				}]
			
			});
			

			setLegend([(8.09).toFixed(2), (3.63).toFixed(2), (1.23).toFixed(2), (0.5).toFixed(2)], ['#000000', '#400000', '#800000', '#bf0000', '#ff0000']);	
			
			// STATIC MAP: LEGEND for values
			function setLegend(values, colors){
				legend_mainmap = L.control({position: 'bottomright'});
				legend_mainmap.onAdd = function(map) {
					var div = L.DomUtil.create("div");
					var content = '<div id="legenddiv" class="leaflet-bar custom-control legend">';
						content += '<div class="legendcolumnlist">';
							content += '<div class="legenditem">';
								content += '<div style="background-color: '+colors[0]+'; width: 27px; height: 16px; margin-right: 5px;"></div>';
								content += '<span>'+values[0]+' < </span>';
							content += '</div>';
							content += '<div class="legenditem">';
								content += '<div style="background-color: '+colors[1]+'; width: 27px; height: 16px; margin-right: 5px;"></div>';
								content += '<span>'+values[1]+' - '+values[0]+'</span>';
							content += '</div>';
							content += '<div class="legenditem">';
								content += '<div style="background-color: '+colors[2]+'; width: 27px; height: 16px; margin-right: 5px;"></div>';
								content += '<span>'+values[2]+' - '+values[1]+'</span>';
							content += '</div>';
							content += '<div class="legenditem">';
								content += '<div style="background-color: '+colors[3]+'; width: 27px; height: 16px; margin-right: 5px;"></div>';
								content += '<span>'+values[3]+' - '+values[2]+'</span>';
							content += '</div>';
							content += '<div class="legenditem">';
								content += '<div style="background-color: '+colors[4]+'; width: 27px; height: 16px; margin-right: 5px;"></div>';
								content += '<span> > '+values[3]+'</span>';
							content += '</div>';
						content += '</div>';
					content += '</div>';
					
					div.innerHTML = content;
					  
					return div;
					
				};
				legend_mainmap.addTo(map);
			};
			
			// STATIC MAP: LEGEND for GRADIENTS
			function setLegend_gradient(values, unit, colors, targetmap){
				legend_mainmap = L.control({position: 'bottomright'});
				legend_mainmap.onAdd = function(map) {
				
				function colorcount(){
						var result = "";
						for (var i = 0; i<colors.length; i++) { result = result + colors[i] + ", " }
						result = result.slice(0, -2);
						return result;						
					}		
				
					var div = L.DomUtil.create("div");
					var content = '<div id="legenddiv" class="leaflet-bar custom-control legend">';
						content += '<div style="display: flex; flex-direction: column; margin-top: 4px; width: 130px;">';
							content += '<div style="background: linear-gradient(to right, '+colorcount()+') ; width: 100%; height: 14px;"></div>';
							content += '<div style="display: flex; flex-direction: row; justify-content: space-between;"><span>'+values[0]+'</span><span>'+values[1]+'</span></div><div style="display: flex; flex-direction: row; justify-content: center;">'+unit+'</div>';
						content += '</div>';
					content += '</div>';
					 
					div.innerHTML = content;
					  
					return div;
					
				};
				legend_mainmap.addTo(map);
			};
			
			
			map.on('baselayerchange', function (e) {
				map.removeControl(legend_mainmap);
				if (e.name === 'Deforestation % ') {
					setLegend([8.0892.toFixed(2), 3.6333.toFixed(2), 1.2308.toFixed(2), 0.4993.toFixed(2)], ['#000000', '#400000', '#800000', '#bf0000', '#ff0000']);
				}  else if (e.name === 'Population density') {
					setLegend([parseFloat(6.180).toLocaleString(), parseFloat(4.790).toLocaleString(), parseFloat(3.210).toLocaleString(), parseFloat(1.910).toLocaleString()], ['#4c4c00', '#7f7f00', '#b2b200', '#e5e500', '#ffff00']);
				} else if (e.name === 'GDP ') {
					setLegend([98.75, 72.75, 26.25, 9.75], ['#111111', '#333333', '#555555', '#777777', '#999999']);
				} else if (e.name === 'NIRv') {
					setLegend_gradient([-0.082, 0.332], '', chroma.scale(['white', 'green']).colors(2), map); // first param is labels: [mix, max], second param is the colors from-to (min, then max)
				} else if (e.name === 'Precipitation') {
					setLegend_gradient([0, parseFloat(0.0616789758*1000).toFixed(3)], 'mm/day', chroma.scale(['red', 'orange', 'yellow', 'green', 'cyan', 'blue']).colors(5), map); // first param is labels: [mix, max], second param is the colors from-to (min, then max)
				} 
			});
			
			/////////////////////////////////
			// DYNAMIC DATA, ANIMATED MAP: //
			/////////////////////////////////
			
			// map div 2, for dynamic data 
			var map_dynamic = L.map('map_dynamic', {maxBounds: L.latLngBounds(L.latLng(-30, -90), L.latLng(15, -30)),
								maxBoundsViscosity: 1.0
									}).setView([-5,-60], 4);
			map_dynamic.addControl(new L.Control.Fullscreen());			
			map_dynamic.scrollWheelZoom.disable();
			
			var OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map_dynamic);
			
			// SLIDER BUTTON PANEL
			var buttonpanelControl = L.control({position: 'bottomleft'});
			buttonpanelControl.onAdd = function () {
				  var div = L.DomUtil.create('div');
				  div.innerHTML = '<div class="leaflet-bar custom-control" style="display: flex; flex-direction: column; align-items: center;"><div style="width: 100%">Precipitation 2001-2021 (monthly mean)</div><div style="display: flex; flex-direction: row; align-items: center; justify-content: space-around; width: 100%;">						<span id="month" style="width: 20%;"> </span> <div><input id="loopcheckbox" name="loopcheckbox" type="checkbox" checked>						<label for="loopcheckbox">Loop</label></div><input type="button" value="Start" onclick="startStop(this)" />						</div><input id="monthslider" type="range" min="1" max="12" oninput="datumBeall(this.value)" style="width: 200px"/></div>';	
				  
					L.DomEvent.disableClickPropagation(div);
				  return div;
			};
			buttonpanelControl.addTo(map_dynamic);			
			buttonpanelControl.getContainer().addEventListener('mouseover', function () {
				map_dynamic.dragging.disable();
			});
			buttonpanelControl.getContainer().addEventListener('mouseout', function () {
				map_dynamic.dragging.enable();
			});
					
			// DYNAMIC MAP: LEGEND for GRADIENTS
			function setLegend_gradient_dynamic(values, unit, colors, targetmap){
				legend = L.control({position: 'bottomright'});
				legend.onAdd = function(map_dynamic) {
					var div = L.DomUtil.create("div");
					var content = '<div id="legenddiv" class="leaflet-bar custom-control legend">';
						content += '<div style="display: flex; flex-direction: column; margin-top: 4px; width: 130px;">';
							content += '<div style="background: linear-gradient(to right, '+colors[0]+', '+colors[1]+'); width: 100%; height: 14px;"></div>';
							content += '<div style="display: flex; flex-direction: row; justify-content: space-between;"><span>'+values[0]*1000+'</span><span>'+values[1]*1000+'</span></div><div style="display: flex; flex-direction: row; justify-content: center;">'+unit+'</div>';
						content += '</div>';
					content += '</div>';
					 
					div.innerHTML = content;
					  
					return div;
					
				};
				legend.addTo(map_dynamic);
			};
			
			var month = 1;
			document.getElementById('month').innerHTML=swapMonthNumberwithName(month);
			document.getElementById('monthslider').value=month;
			
			var x=new XMLHttpRequest();
			x.open('get', 'data/main_map_2.geojson', false);
			x.send();
			var d=JSON.parse(x.responseText);
			var dynamicmap_stateborders = L.geoJSON(d, {style: function (feature) { return {color: "#ffffff", fill: false} }, onEachFeature: function (feature, layer) {
				layer.bindTooltip(feature.properties.sigla, {permanent: true, direction:"center"});} });
				dynamicmap_stateborders.getAttribution = function() { return 'TerraBrasilis'; };
			dynamicmap_stateborders.addTo(map_dynamic)			
											
							
			// GeoTIFF in dynamic map
			var layerPrecip;
			var tifftooltip_precip;
			var layerControl_dynamic;
			var precip_range;
			
			function loadTiff(filename) {
				d3.request(filename).responseType('arraybuffer').get( function (error, tiffData) {
				
					// if there is a geotiff layer loaded, remove it first
					if (layerPrecip != null) {
						layerPrecip.remove();
					}
				
					let precip = L.ScalarField.fromGeoTIFF(tiffData.response, bandIndex = 0);
					layerPrecip = L.canvasLayer.scalarField(precip, {
							color: chroma.scale(['rgba(0,0,0,0)','rgba(0,0,255,0.5)', 'rgba(0,0,255,0.6)', 'rgba(0,0,255,0.7)' , 'rgba(0,0,255,0.82)' , 'blue']).domain([0, 0.085]),		// domain: the range. can be precip.range as well, range will be automatic from data then
							opacity: 1,
							attribution: '© 2022 <a href="www.ecmwf.int">European Centre for Medium-Range Weather Forecasts (ECMWF)</a>'
							});
					precip_range = precip.range;
					//console.log(precip_range)					
					
					// what happens upon mouse hover over the raster
					layerPrecip.on("mousemove", function(e) {
						// mouse moved
						if (e.value !== null) {							// value under mouse is not null
							if (tifftooltip_precip !== null) {			// if tifftooltip is already open, close the previous tooltip so it does not get stuck on map
								map_dynamic.closeTooltip(tifftooltip_precip);
							}
							// create tooltip:
							tifftooltip_precip = L.tooltip()
								.setLatLng(e.latlng)
								.setContent(parseFloat(`${e.value*1000}`).toFixed(3) + ' mm/day'); // CONVERSION FROM M/DAY TO MM/DAY
							map_dynamic.openTooltip(tifftooltip_precip);			// open tooltip
						} else {										// value is null
							if (tifftooltip_precip !== null) {			// if any tooltip is open, close it since we went elsewhere from the area with the cursor, so previous one does not get stuck
								map_dynamic.closeTooltip(tifftooltip_precip);
							}
						}
					});
					
					// add the geotiff layer to map
					layerPrecip.addTo(map_dynamic);										
					
					// if there is no layer switcher yet, create one
					if (layerControl_dynamic == null) {
						setLegend_gradient_dynamic([0, 0.085], 'mm/day', chroma.scale(['rgba(0,0,0,0)','rgba(0,0,255,0.5)', 'rgba(0,0,255,0.6)', 'rgba(0,0,255,0.7)' , 'rgba(0,0,255,0.82)' , 'blue']).colors(6), map_dynamic);
						// first run, add to map so we see by default, create layer switcher
						overlayMaps_dynamic = { "Precipitation (mean)": layerPrecip };
						layerControl_dynamic = L.control.layers(overlayMaps_dynamic, {"States": dynamicmap_stateborders}, {collapsed:false}).addTo(map_dynamic); 
					}
				  
				});	
					
			}
			
			// load by default
			loadTiff('data/meanmonths/precip_01.tif');
				
			function datumBeall(ho){
				document.getElementById('month').innerHTML = swapMonthNumberwithName(parseInt(ho));
				var nextfilename = 'data/meanmonths/precip_'+String(ho).padStart(2, '0')+'.tif';
				console.log(nextfilename)
				loadTiff(nextfilename);				
			}
			
			var idozito;
			
			function startStop(b){
				if (b.value=="Start" || b.value=="Replay") {
					// ha veget ert az animacio, megallt mert nem loopos, es az ujra gombra kattintunk, visszaallitjuk a 2000-re
					if (month => 12) {
						month = 0;
					}
					// elinditjuk a lejatszast
					idozito=setInterval(function(){
						document.getElementById('monthslider').disabled = true;
						month+=1;
						if (month > 12) {
							// a vegere ertunk, loop ellenorzes
							if (document.getElementById('loopcheckbox').checked) {
								// loop igen, menjunk elolrol
								month = 1;
							} else {
								// loop nem, alljunk meg a vegen
								month-=1;
								clearInterval(idozito);
								document.getElementById('monthslider').disabled = false;
								// gomb: "Replay"-t irjon, mert megalltunk es a vegen vagyunk
								b.value="Replay";
							}
						}
						datumBeall(month);
						document.getElementById('monthslider').value=month;
					},500); // 500 ms per step
					b.value="Stop";
				} else {
					// megallitjuk
					document.getElementById('monthslider').disabled = false;
					clearInterval(idozito);
					b.value="Start";
				}
			}
			
			function swapMonthNumberwithName(num) {
				switch(num) {
				  case 1:
					return 'January';
				  case 2:
					return 'February';
				  case 3:
					return 'March';
				  case 4:
					return 'April';
				  case 5:
					return 'May';
				  case 6:
					return 'June';
				  case 7:
					return 'July';
				  case 8:
					return 'August';
				  case 9:
					return 'September';
				  case 10:
					return 'October';
				  case 11:
					return 'November';
				  case 12:
					return 'December';
				  default:
					return num;
				} 
			}
			
			map_dynamic.on('baselayerchange', function (e) {
				map_dynamic.removeControl(legend);
				if (e.name === 'Precipitation (mean)') {
					setLegend_gradient([0, 0.085], 'mm/day', chroma.scale(['black', 'orange']).colors(2), map_dynamic);
				} 
			});
			 
			 
			 function tooltip_slope(layer) {
				return "<b><div style='font-size:20px'>" + layer.feature.properties.nome + "</div></b><br> Slope: " + layer.feature.properties.slope_slope;
			}
			function tooltip_r2(layer) {
				return "<b><div style='font-size:20px'>" + layer.feature.properties.nome + "</div></b><br> R<sup>2</sup>: " + layer.feature.properties.correlation_r2_values_leaflet_r2;
			}
			 
			 // map div object,  Leaflet2 object:
			 
			var map_2 = L.map('map_2',{maxBounds: L.latLngBounds(L.latLng(-29.935789, -94.974456), L.latLng(22.153948, -27.264859)),
								maxBoundsViscosity: 1.0
									}).setView([-6.641224624683114,-55.6095886343115], 4); 
			map_2.addControl(new L.Control.Fullscreen());
			map_2.scrollWheelZoom.disable();
			
			// base maps
			var OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map_2);
			
			// overlays			
			var x=new XMLHttpRequest();
			x.open('get', 'data/correlation_r2_slope.geojson', false);
			x.send();
			var d=JSON.parse(x.responseText);
			var mainmap_slope = L.geoJSON(d,{style: stilus_slope, onEachFeature: mousehighlight}).bindTooltip(tooltip_slope);
				mainmap_slope.getAttribution = function() { return 'TerraBrasilis: DETER dataset'; };
			var mainmap_r2 = L.geoJSON(d,{style: stilus_r2, onEachFeature: mousehighlight}).bindTooltip(tooltip_r2);
				mainmap_r2.getAttribution = function() { return 'Instituto Brasileiro de Geografia e Estatística - IBGE'; };
			
			
			// we add the default layer to map to show when page is opened:
				mainmap_slope.addTo(map_2)
			
			// list of overlays
			var overlayMaps_3rd = {
				
				"Slope ": mainmap_slope,
				"R<sup>2</sup>": mainmap_r2
			};
			var layerControl = L.control.layers(overlayMaps_3rd, null, {collapsed:false}).addTo(map_2);
			
			
			
			 // DUAL AXIS CHART 1
			 
			 
			 var data = {
				"datasets": [
				  {
					"backgroundColor": "rgb(165,15,21)",
					"borderColor": "rgb(165,15,21)",
					"fill": false,
					"data": [19.624, 17.85, 29.43, 53.314, 138.498, 128.354, 244.602, 226.432, 331.004, 155.59, 37.276, 33.356],
					"label": "Deforestation (Km\u00B2)",
					"yAxisID":"y1"
				  },
				  {
					"backgroundColor": "rgb(39, 176, 200)",
					"borderColor": "rgb(39, 176, 200)",
					"fill": false,
					"data": [9.862585687, 9.80565275, 10.82662277, 11.46246432, 9.35921619, 4.988833866, 2.98230954, 2.798426994, 3.997075154, 5.718009035, 8.270209801, 10.44341969],
					"label": "Precipitation (mm/day)",
					"yAxisID":"y2"
				  }
				],
				"labels": [
				  "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
			  };
			  
			var options = {
				responsive: true,
				interaction: {
					mode: 'index',
					intersect: false
				},
				elements: {
				  "rectangle": {
					"borderWidth": 2
				  }
				},
				layout: {
				  "padding": 0
				},
				legend: {
				  "display": true,
				  "labels": {
					"boxWidth": 16
				  }
				},
				maintainAspectRatio: false,
				responsive: true,
				scales: {
					"y1": {
						position: 'left'
					},
					"y2": {
						position: 'right',
						grid: {
						  drawOnChartArea: false, // only want the grid lines for one axis to show up
						}
					}
				},
				tooltips: {
				  "intersect": false,
				  "mode": "index",
				  "position": "nearest",
				  "callbacks": {}
				}
			};
				
			var type = "line";

			var myChart = new Chart(document.getElementById("dualaxisChart").getContext('2d'), {options: options, data: data, type: type});
			
			
			
			// DUAL AXIS CHART 2
			
			var data2 = {
				"datasets": [
				  {
					"backgroundColor": "rgb(165,15,21)",
					"borderColor": "rgb(165,15,21)",
					"fill": false,
					"data": [27.718, 4.07, 1.8, 42.48, 4.924, 13.552, 2.344, 29.688, 87.424, 37.168, 25.976, 4.184],
					"label": "Deforestation (Km\u00B2)",
					"yAxisID":"y1"
				  },
				  {
					"backgroundColor": "rgb(39, 176, 200)",
					"borderColor": "rgb(39, 176, 200)",
					"fill": false,
					"data": [8.682142972, 12.62437333, 11.56642087, 8.811882839, 3.618205447, 1.155493223, 0.716872719, 0.346232603, 0.627226216, 1.625703192, 5.090730096, 6.503446867],
					"label": "Precipitation (mm/day)",
					"yAxisID":"y2"
				  }
				],
				"labels": [
				  "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"]
			  };
			  
			
			var myChart2 = new Chart(document.getElementById("dualaxisChart2").getContext('2d'), {options: options, data: data2, type: type});
			
			
			// DUAL AXIS CHART 3
			
			var data3 = {
				"datasets": [
				  {
					"backgroundColor": "rgb(165,15,21)",
					"borderColor": "rgb(1165,15,21)",
					"fill": false,
					"data": [482, 435, 865, 773, 932, 684, 1030, 1376, 1243, 1316, 1257, 1273, 1673],
					"label": "Deforestation (Km\u00B2)",
					"yAxisID":"y1"
				  },
				  {
					"backgroundColor": "rgb(39, 176, 200)",
					"borderColor": "rgb(39, 176, 200)",
					"fill": false,
					"data": [8.12, 6.92, 7.91, 7.31, 7.86, 8.11, 7.26, 7.45, 7.70, 7.09, 8.13, 7.12, 7.67],
					"label": "Precipitation (mm/day)",
					"type": 'line',
					"yAxisID":"y2"
				  },
				  {
					"backgroundColor": "rgb(255, 99, 132)",
					"borderColor": "rgb(255, 99, 132)",
					"fill": false,
					"data": [19725010, 23907887, 27574714, 30112720, 31121413, 34030982, 36563333, 39460359, 43516147, 44913978, 47091336],
					"label": "GDP",
					"type": 'line',
					"yAxisID":"y3"
				  }
				],
				"labels": [
				  "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017", "2018", "2019", "2020", "2021"]
			  };
			  
			  var options2 = {
				responsive: true,
				interaction: {
					mode: 'index',
					intersect: false
				},
				elements: {
				  "rectangle": {
					"borderWidth": 2
				  }
				},
				layout: {
				  "padding": 0
				},
				legend: {
				  "display": true,
				  "labels": {
					"boxWidth": 16
				  }
				},
				maintainAspectRatio: false,
				responsive: true,
				scales: {
					"y1": {
						position: 'left'
					},
					"y2": {
						position: 'right',
						grid: {
						  drawOnChartArea: false, // only want the grid lines for one axis to show up
						}
					},
					"y3": {
						position: 'right',
						grid: {
						  drawOnChartArea: false, // only want the grid lines for one axis to show up
						}
					}
				},
				tooltips: {
				  "intersect": false,
				  "mode": "index",
				  "position": "nearest",
				  "callbacks": {}
				}
			};
				
			var type = "bar";
			
			var myChart3 = new Chart(document.getElementById("dualaxisChart3").getContext('2d'), {options: options2, data: data3, type: type});

		
			// SCATTER Plot 1
			
			var ctx = document.getElementById("scatterplot").getContext('2d');

			// Define the data 
			var data3 = [{
							x: 9.8625856866,
							y: 19.624
						}, {
							x: 9.8056527496,
							y: 17.85
						},
						{
							x: 10.8266227666,
							y: 29.43
						},
						{
							x: 11.46246432,
							y: 53.314
						},
						{
							x: 9.3592161904,
							y: 138.498
						},
						{
							x: 4.988833866,
							y: 128.354
						},
						{
							x: 2.9823095396,
							y: 244.602
						},
						{
							x: 2.7984269938,
							y: 226.432
						},
						{
							x: 3.9970751536,
							y: 331.004
						},
						{
							x: 5.7180090346,
							y: 155.59
						},
						{
							x: 8.2702098008,
							y: 37.276
						},
						{
							x: 10.4434196884,
							y: 33.356
						}
					 ]; // Add data values to array
			// End Defining data
			var options_scatter = {responsive: true, // Instruct chart js to respond nicely.
				maintainAspectRatio: false,
				scales: {
					y: {
					  title: {
						display: true,
						text: 'Deforestation Km\u00B2'
					  }
					},
					x: {
					  title: {
						display: true,
						text: 'Precipitation mm/day'
					  }
					}
				},
				interaction: {
						mode: 'index',
						intersect: false
					}				// Add to prevent default behaviour of full-width/height 
			};

			// End Defining data
			var myChart3 = new Chart(ctx, {
				type: 'scatter',
				data: {
					datasets: [{
							label: 'Deforestation - Precipitation', // Name the series
							data: data3, // Specify the data values array
					  borderColor: '#2196f3', // Add custom color border            
					  backgroundColor: '#2196f3', 
					  trendlineLinear: {
							lineStyle: "solid",
							width: 2
						}// Add custom color background (Points and Fill)
					}]
				},
				options: options_scatter
			});
			
			
			// SCATTER Plot 2
			
			var ctx = document.getElementById("scatterplot2").getContext('2d');

			// Define the data 
			var data4 = [{
							x: 8.68214297199991,
							y: 27.718
						}, {
							x: 12.6243733272332,
							y: 4.07
						},
						{
							x: 11.5664208675017,
							y: 1.8
						},
						{
							x: 8.81188283859937,
							y: 42.48
						},
						{
							x: 3.61820544731617,
							y: 4.924
						},
						{
							x: 1.15549322276073,
							y: 13.552
						},
						{
							x: 0.716872719471636,
							y: 2.344
						},
						{
							x: 0.346232602552039,
							y: 29.688
						},
						{
							x: 0.627226215892753,
							y: 87.424
						},
						{
							x: 1.6257031918881,
							y: 37.168
						},
						{
							x: 5.09073009614505,
							y: 25.976
						},
						{
							x: 6.50344686698301,
							y: 4.184
						}
					 ]; // Add data values to array
			// End Defining data
			

			// End Defining data
			var myChart4 = new Chart(ctx, {
				type: 'scatter',
				data: {
					datasets: [{
							label: 'Deforestation - Precipitation', // Name the series
							data: data4, // Specify the data values array
					  borderColor: '#2196f3', // Add custom color border            
					  backgroundColor: '#2196f3', 
					  trendlineLinear: {
							lineStyle: "solid",
							width: 2
						}// Add custom color background (Points and Fill)
					}]
				},
				options: options_scatter
			});
		</script>
	</body>
</html>